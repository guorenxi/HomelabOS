---
- name: Deploy HLOS services
  hosts: all

  tasks:
  ## This one might actually be the only thing to deploy, then we fetch the docker file and what not from in there.
  ## 
  - name: Deploy hlos files to server
    git:
      repo: https://gitlab.com/NickBusey/HomelabOS.git
      # version: master
      version: 220_add_remote_deploy_of_hlos_ansible_api
      dest: "{{ volumes_root }}/install"
      accept_hostkey: true

  - name: Copy vault password file to remote
    copy:
      src: "{{ lookup('env', 'HOME') }}/.homelabos_vault_pass"
      dest: "/home/{{ user_name }}/.homelabos_vault_pass"

  ## NOTE: Maybe copy from remote to remote, but copy from client eases development.
  - name: Copy ansible-api Docker file to remote
    copy:
      src: docker
      dest: "{{ volumes_root }}/ansible-api/"
      
  - name: Copy docker build files into place
    template:
      src: templates/entrypoint.sh.j2
      dest: "{{ volumes_root }}/ansible-api/docker/entrypoint.sh"

  - name: Build ansible-api image
    docker_image:
      name: ansible-api
      tag: latest
      build:
        path: "{{ volumes_root }}/ansible-api/docker"
        pull: true
        rm: true
      source: build
      state: present

  - name: Copy docker-compose into place
    template:
      src: docker-compose.yml.j2
      dest: "{{ volumes_root }}/ansible-api/docker-compose.yml"

  - name: Configure ansible-api systemd service.
    template:
      src: service.j2
      dest: /etc/systemd/system/ansible-api.service
    become: true

  - name: Start ansible-api
    systemd:
      name: ansible-api
      enabled: true
      daemon-reload: true
      state: started
    become: true
